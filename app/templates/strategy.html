{% extends "base.html" %}

{% block title %}거래 전략 - Bithumb 자동매매{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2><i class="bi bi-bar-chart-line"></i> 거래 전략</h2>
        <p class="text-muted">전략을 선택하고 자동 매매를 시작하세요</p>
    </div>
</div>

{% if request.query_params.get('success') == 'true' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle"></i> 전략이 성공적으로 저장되었습니다!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Unified Strategy Creation -->
<div class="row mb-4">
    <div class="col-lg-12 mx-auto">
        <div class="card card-custom">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-plus-circle text-primary"></i> 새 전략 생성
                </h5>
                <p class="card-text text-muted">전략 타입을 선택하고 파라미터를 설정하세요</p>
                <hr>
                <form method="POST" action="/strategy/create" id="strategyForm">
                    <!-- 전략 타입 선택 -->
                    <div class="mb-3">
                        <label class="form-label">전략 타입</label>
                        <select class="form-select" name="strategy_type" id="strategyType" required>
                            <option value="">-- 전략 선택 --</option>
                            <option value="bollinger">볼린저 밴드</option>
                            <option value="moving_average">이동평균 크로스오버</option>
                            <option value="rsi">RSI 전략</option>
                            <option value="macd">MACD 전략</option>
                            <option value="stochastic">스토캐스틱 전략</option>
                            <option value="composite">복합 전략</option>
                        </select>
                        <small class="text-muted" id="strategyDescription"></small>
                    </div>

                    <!-- 공통 파라미터 -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">코인</label>
                            <select class="form-select" name="coin" required>
                                <option value="">코인 선택</option>
                                {% for coin in available_coins %}
                                    <option value="{{ coin }}">{{ coin }} {% if coin in coin_names_dict and coin_names_dict[coin].korean %}- {{ coin_names_dict[coin].korean }}{% endif %}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">빗썸에서 거래 가능한 {{ available_coins|length if available_coins else 6 }}개의 코인</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">1회 매수 금액 (KRW)</label>
                            <input type="number" class="form-control" name="trade_amount_krw" value="10000" min="6000" step="1000" required>
                            <small class="text-muted">최소 6,000원 (빗썸 최소 주문 5,000원 + 안전 마진)</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">매수 가능 금액 (KRW)</label>
                            <input type="number" class="form-control" name="max_buy_amount" value="100000" min="0" step="10000">
                            <small class="text-muted">누적 매수 한도 (0이면 무제한)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">목표 수익률 (%)</label>
                            <input type="number" class="form-control" name="profit_target" value="5.0" min="0.1" step="0.1">
                            <small class="text-muted">이 수익률 달성 시 자동 매도</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">손절 비율 (%)</label>
                        <input type="number" class="form-control" name="stop_loss" value="3.0" min="0" step="0.1">
                        <small class="text-muted">0이면 손절 안함</small>
                    </div>

                    <hr>
                    <div id="strategyParams"></div>

                    <button type="submit" class="btn btn-primary w-100" id="submitBtn" disabled>
                        <i class="bi bi-play-circle"></i> 전략 시작
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const strategyDescriptions = {
        'bollinger': '가격이 하단 밴드에 닿으면 매수, 상단 밴드에 닿으면 매도',
        'moving_average': '단기 이동평균이 장기 이동평균을 교차할 때 매매',
        'rsi': 'RSI가 과매도/과매수 구간에 진입할 때 매매',
        'macd': 'MACD 라인이 시그널 라인을 교차할 때 매매',
        'stochastic': '스토캐스틱이 과매도/과매수 구간에서 교차할 때 매매',
        'composite': '여러 전략을 조합하여 신호 확인 후 매매'
    };

    const strategyParams = {
        'bollinger': `
            <div class="mb-3">
                <label class="form-label">기간 (일)</label>
                <input type="number" class="form-control" name="period" value="20" min="5" max="100">
            </div>
            <div class="mb-3">
                <label class="form-label">표준편차 배수</label>
                <input type="number" class="form-control" name="std_dev" value="2.0" step="0.1" min="1" max="3">
            </div>
        `,
        'moving_average': `
            <div class="mb-3">
                <label class="form-label">단기 기간</label>
                <input type="number" class="form-control" name="short_period" value="5" min="3" max="50">
            </div>
            <div class="mb-3">
                <label class="form-label">장기 기간</label>
                <input type="number" class="form-control" name="long_period" value="20" min="10" max="200">
            </div>
        `,
        'rsi': `
            <div class="mb-3">
                <label class="form-label">RSI 기간</label>
                <input type="number" class="form-control" name="period" value="14" min="5" max="30">
            </div>
            <div class="mb-3">
                <label class="form-label">과매도 (매수)</label>
                <input type="number" class="form-control" name="oversold" value="30" min="10" max="40">
            </div>
            <div class="mb-3">
                <label class="form-label">과매수 (매도)</label>
                <input type="number" class="form-control" name="overbought" value="70" min="60" max="90">
            </div>
        `,
        'macd': `
            <div class="mb-3">
                <label class="form-label">빠른 기간</label>
                <input type="number" class="form-control" name="fast_period" value="12" min="5" max="50">
            </div>
            <div class="mb-3">
                <label class="form-label">느린 기간</label>
                <input type="number" class="form-control" name="slow_period" value="26" min="10" max="100">
            </div>
            <div class="mb-3">
                <label class="form-label">시그널 기간</label>
                <input type="number" class="form-control" name="signal_period" value="9" min="5" max="30">
            </div>
        `,
        'stochastic': `
            <div class="mb-3">
                <label class="form-label">K 기간</label>
                <input type="number" class="form-control" name="k_period" value="14" min="5" max="30">
            </div>
            <div class="mb-3">
                <label class="form-label">D 기간</label>
                <input type="number" class="form-control" name="d_period" value="3" min="2" max="10">
            </div>
            <div class="mb-3">
                <label class="form-label">과매도 (매수)</label>
                <input type="number" class="form-control" name="oversold" value="20" min="10" max="30">
            </div>
            <div class="mb-3">
                <label class="form-label">과매수 (매도)</label>
                <input type="number" class="form-control" name="overbought" value="80" min="70" max="90">
            </div>
        `,
        'composite': `
            <div class="mb-3">
                <label class="form-label">조합할 전략들</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="strategy_types" value="moving_average" id="comp_ma">
                    <label class="form-check-label" for="comp_ma">이동평균</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="strategy_types" value="rsi" id="comp_rsi">
                    <label class="form-check-label" for="comp_rsi">RSI</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="strategy_types" value="macd" id="comp_macd">
                    <label class="form-check-label" for="comp_macd">MACD</label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">최소 확인 신호 개수</label>
                <input type="number" class="form-control" name="min_confirmations" value="2" min="1" max="3">
                <small class="text-muted">이 개수 이상의 전략이 동의할 때만 매매</small>
            </div>
        `
    };

    document.getElementById('strategyType').addEventListener('change', function() {
        const strategyType = this.value;
        const descElement = document.getElementById('strategyDescription');
        const paramsElement = document.getElementById('strategyParams');
        const submitBtn = document.getElementById('submitBtn');

        if (strategyType) {
            descElement.textContent = strategyDescriptions[strategyType] || '';
            paramsElement.innerHTML = strategyParams[strategyType] || '';
            submitBtn.disabled = false;
        } else {
            descElement.textContent = '';
            paramsElement.innerHTML = '';
            submitBtn.disabled = true;
        }
    });
</script>

<!-- Active Strategies -->
<div class="row">
    <div class="col-12">
        <div class="card card-custom">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i> 활성화된 전략
                </h5>
            </div>
            <div class="card-body">
                {% if strategy_performances %}

                <!-- Desktop Table View (md and up) -->
                <div class="d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>전략</th>
                                    <th>코인</th>
                                    <th>유형</th>
                                    <th class="text-end">보유량</th>
                                    <th class="text-end">투자금</th>
                                    <th class="text-end">현재가치</th>
                                    <th class="text-end">손익</th>
                                    <th class="text-end">수익률</th>
                                    <th class="text-center">상태</th>
                                    <th class="text-center">작업</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for perf in strategy_performances %}
                                <tr>
                                    <td>
                                        <strong class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ perf.strategy.name }}">
                                            {{ perf.strategy.name }}
                                        </strong>
                                    </td>
                                    <td><span class="badge bg-dark">{{ perf.strategy.coin }}</span></td>
                                    <td>
                                        {% if perf.strategy.strategy_type == 'bollinger' %}
                                        <span class="badge bg-primary">볼린저</span>
                                        {% elif perf.strategy.strategy_type == 'moving_average' %}
                                        <span class="badge bg-success">이동평균</span>
                                        {% elif perf.strategy.strategy_type == 'rsi' %}
                                        <span class="badge bg-warning text-dark">RSI</span>
                                        {% elif perf.strategy.strategy_type == 'macd' %}
                                        <span class="badge bg-info text-dark">MACD</span>
                                        {% elif perf.strategy.strategy_type == 'stochastic' %}
                                        <span class="badge bg-secondary">Stochastic</span>
                                        {% elif perf.strategy.strategy_type == 'composite' %}
                                        <span class="badge bg-dark">복합</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if perf.holdings > 0 %}
                                        <small>{{ "%.4f"|format(perf.holdings) }}</small>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if perf.total_invested > 0 %}
                                        <small>₩{{ "{:,.0f}".format(perf.total_invested) }}</small>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if perf.current_value > 0 %}
                                        <small>₩{{ "{:,.0f}".format(perf.current_value) }}</small>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if perf.total_profit != 0 %}
                                            {% if perf.total_profit > 0 %}
                                            <span class="text-success fw-bold">+₩{{ "{:,.0f}".format(perf.total_profit) }}</span>
                                            {% else %}
                                            <span class="text-danger fw-bold">₩{{ "{:,.0f}".format(perf.total_profit) }}</span>
                                            {% endif %}
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if perf.roi != 0 %}
                                            {% if perf.roi > 0 %}
                                            <span class="badge bg-success">+{{ "%.2f"|format(perf.roi) }}%</span>
                                            {% else %}
                                            <span class="badge bg-danger">{{ "%.2f"|format(perf.roi) }}%</span>
                                            {% endif %}
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if perf.strategy.enabled %}
                                        <span class="badge bg-success">활성</span>
                                        {% else %}
                                        <span class="badge bg-secondary">비활성</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="/strategy/logs/{{ perf.strategy.id }}" class="btn btn-outline-info" title="로그">
                                                <i class="bi bi-list-ul"></i>
                                            </a>
                                            <form method="POST" action="/strategy/toggle/{{ perf.strategy.id }}" style="display:inline;">
                                                <button type="submit" class="btn btn-outline-secondary" title="{% if perf.strategy.enabled %}일시정지{% else %}시작{% endif %}">
                                                    {% if perf.strategy.enabled %}
                                                    <i class="bi bi-pause"></i>
                                                    {% else %}
                                                    <i class="bi bi-play"></i>
                                                    {% endif %}
                                                </button>
                                            </form>
                                            <form method="POST" action="/strategy/delete/{{ perf.strategy.id }}" style="display:inline;">
                                                <button type="submit" class="btn btn-outline-danger" onclick="return confirm('정말 삭제하시겠습니까?')" title="삭제">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mobile Card View (sm and below) -->
                <div class="d-md-none">
                    {% for perf in strategy_performances %}
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center py-2"
                             style="background: {% if perf.roi > 0 %}#d1fae5{% elif perf.roi < 0 %}#fee2e2{% else %}#f3f4f6{% endif %};">
                            <div>
                                <span class="badge bg-dark me-1">{{ perf.strategy.coin }}</span>
                                {% if perf.strategy.strategy_type == 'bollinger' %}
                                <span class="badge bg-primary">볼린저</span>
                                {% elif perf.strategy.strategy_type == 'moving_average' %}
                                <span class="badge bg-success">이동평균</span>
                                {% elif perf.strategy.strategy_type == 'rsi' %}
                                <span class="badge bg-warning text-dark">RSI</span>
                                {% elif perf.strategy.strategy_type == 'macd' %}
                                <span class="badge bg-info text-dark">MACD</span>
                                {% elif perf.strategy.strategy_type == 'stochastic' %}
                                <span class="badge bg-secondary">Stochastic</span>
                                {% elif perf.strategy.strategy_type == 'composite' %}
                                <span class="badge bg-dark">복합</span>
                                {% endif %}
                            </div>
                            <div>
                                {% if perf.strategy.enabled %}
                                <span class="badge bg-success">활성</span>
                                {% else %}
                                <span class="badge bg-secondary">비활성</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <h6 class="card-title text-truncate mb-3" title="{{ perf.strategy.name }}">
                                {{ perf.strategy.name }}
                            </h6>

                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div class="small text-muted">보유량</div>
                                    <div class="fw-semibold">
                                        {% if perf.holdings > 0 %}
                                        {{ "%.4f"|format(perf.holdings) }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted">투자금</div>
                                    <div class="fw-semibold">
                                        {% if perf.total_invested > 0 %}
                                        ₩{{ "{:,.0f}".format(perf.total_invested) }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted">현재가치</div>
                                    <div class="fw-semibold">
                                        {% if perf.current_value > 0 %}
                                        ₩{{ "{:,.0f}".format(perf.current_value) }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted">수익률</div>
                                    <div>
                                        {% if perf.roi != 0 %}
                                            {% if perf.roi > 0 %}
                                            <span class="badge bg-success fs-6">+{{ "%.2f"|format(perf.roi) }}%</span>
                                            {% else %}
                                            <span class="badge bg-danger fs-6">{{ "%.2f"|format(perf.roi) }}%</span>
                                            {% endif %}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            {% if perf.total_profit != 0 %}
                            <div class="alert {% if perf.total_profit > 0 %}alert-success{% else %}alert-danger{% endif %} py-2 mb-3">
                                <div class="small">손익</div>
                                <div class="fw-bold">
                                    {% if perf.total_profit > 0 %}
                                    +₩{{ "{:,.0f}".format(perf.total_profit) }}
                                    {% else %}
                                    ₩{{ "{:,.0f}".format(perf.total_profit) }}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="d-grid gap-2">
                                <div class="btn-group" role="group">
                                    <a href="/strategy/logs/{{ perf.strategy.id }}" class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-list-ul"></i> 로그
                                    </a>
                                    <form method="POST" action="/strategy/toggle/{{ perf.strategy.id }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-secondary">
                                            {% if perf.strategy.enabled %}
                                            <i class="bi bi-pause"></i> 정지
                                            {% else %}
                                            <i class="bi bi-play"></i> 시작
                                            {% endif %}
                                        </button>
                                    </form>
                                    <form method="POST" action="/strategy/delete/{{ perf.strategy.id }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('정말 삭제하시겠습니까?')">
                                            <i class="bi bi-trash"></i> 삭제
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-4"></i>
                    <p class="mt-3">활성화된 전략이 없습니다.</p>
                    <p>위에서 전략을 선택하고 시작하세요.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}